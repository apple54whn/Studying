# 品优购

电商模式有：

- **B2B**（Business to Business）：阿里巴巴
- **C2C**（Customer【顾客】 或 Consumer【消费者】）：淘宝、瓜子、易趣
- **B2C**（Business-to-Customer）：唯品会、乐蜂网
- **C2B**（Consumer to Business）：装修等。先有消费者提出需求，后有生产企业按需求组织生产
- **O2O**（Online To Offline）：饿了么、美团。将线下的商务机会与互联网结合，让互联网成为线下交易的平台
- F2C（Factory to customer）
- **B2B2C**：天猫、京东(混合)。第一个B指的是商品或服务的供应商，第二个B指的是从事电子商务的企业，C则是表示消费者

电商行业技术特点：技术新、技术范围广；分布式；高并发（集群、负载均衡）、高可用；海量数据、业务复杂、系统安全



## 1 分布式框架 Dubbox



### 1.1 品优购需求分析与系统设计

**B2B2C**：品优购网上商城主要分为**网站前台**、**运营商后台**、**商家管理后台**三个子系统

系统架构：**SOA**（Service-Oriented Architecture），是一种支持**面向服务**的架构样式，更多应用于互联网项目开发



### 1.2 Dubbox

> Dubbox 是一个分布式服务框架，前身是阿里巴巴开源项目Dubbo，后阿里巴巴停止了该项目的维护。当当网便在Dubbo基础上进行优化、维护，重新命名Dubbox 以区分。后续还有SpringCloud。

#### 1.2.1 Dubbox简介

Dubbox 致力于提供高性能和透明化的**RPC远程服务调用**方案，以及**SOA服务治理**方案，是远程服务调用的分布式框架

![1546066605296](images/1546066605296.png)

> Dubbox的jar包并没有部署到Maven的中央仓库中，需要手动安装dubbo-2.8.4.jar到本地仓库



#### 1.2.2 注册中心Zookeeper

> 官方推荐，负责服务地址的注册与查找，注册中心不转发请求，压力较小。是 Apacahe Hadoop 的子项目，是一个树型的目录服务，支持变更推送，适合作为Dubbox 服务的注册中心，工业强度较高，可用于生产环境。

Linux中安装Zookeeper（文档提供的Linux用户名root、密码itcast）

> Linux需要修改子网IP中网段为25（FastDNS服务要求）。

1. 安装 jdk
2. 把 zookeeper 的压缩包（资源\配套软件\dubbox\zookeeper-3.4.6.tar.gz）上传到 linux 系统
   - 可以使用SecureCRT连接远程服务器，Alt+P进入SFTP，输入`put d:\zookeeper-3.4.6.tar.gz`上传（SSH也行）
3. 解压：`tar zxvf zookeeper-3.4.6.tar.gz`
4. 进入 zookeeper-3.4.6 目录，创建 data 文件夹：`mkdir data`
5. 进入conf目录 ，把 zoo_sample.cfg 改名为 zoo.cfg：`mv zoo_sample.cfg zoo.cfg`
6. 打开zoo.cfg , 修改 data 属性：`dataDir=/root/zookeeper-3.4.6/data`
7. 进入bin运行/状态/停止等 Zookeeper：`./zkServer.sh start/status/stop等`
8. Zookeeper的端口号为**2181**



#### 1.2.3 Demo

##### 1 服务提供者开发

1. 在pom.xml添加Dubbox依赖（需要安装dubbox到本地Maven仓库），打包方式为**war包**。独立的工程，完成后先运行。

   ```xml
   <dependency>
       <groupId>com.alibaba</groupId>
       <artifactId>dubbo</artifactId>
       <version>2.8.4</version>			
   </dependency>
   <dependency>
       <groupId>org.apache.zookeeper</groupId>
       <artifactId>zookeeper</artifactId>
       <version>3.4.6</version>
   </dependency>
   <dependency>
       <groupId>com.github.sgroschupf</groupId>
       <artifactId>zkclient</artifactId>
       <version>0.1</version>
   </dependency>
   <dependency>
       <groupId>javassist</groupId>
       <artifactId>javassist</artifactId>
       <version>3.11.0.GA</version>
   </dependency>
   ```

2. 在web.xml中添加`ContextLoaderListener`加载`applicationContext*`配置文件，IoC容器的配置文件如下：

   ```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <beans xmlns="http://www.springframework.org/schema/beans"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
          xmlns:p="http://www.springframework.org/schema/p"
          xmlns:context="http://www.springframework.org/schema/context"
          xmlns:dubbo="http://code.alibabatech.com/schema/dubbo" 
          xmlns:mvc="http://www.springframework.org/schema/mvc"
          xsi:schemaLocation="http://www.springframework.org/schema/beans 
                              http://www.springframework.org/schema/beans/spring-beans.xsd
                              http://www.springframework.org/schema/mvc 
                              http://www.springframework.org/schema/mvc/spring-mvc.xsd
                              http://code.alibabatech.com/schema/dubbo 
                              http://code.alibabatech.com/schema/dubbo/dubbo.xsd
                              http://www.springframework.org/schema/context 
                              http://www.springframework.org/schema/context/spring-context.xsd">
   
       <dubbo:protocol name="dubbo" port="20881"></dubbo:protocol><!--每个服务都有的端口，不配置默认为20880-->
       <dubbo:application name="dubboxdemo-service"/>  <!--与工程名相同即可-->
       <dubbo:registry address="zookeeper://192.168.25.129:2181"/> <!--注册中心-->
       <dubbo:annotation package="cn.itcast.dubboxdemo.service" /> <!--使用Dubbox的包扫描@Service-->
   </beans>
   ```

3. 服务层（省略了dao的调用）：导入的**`@Service`注解是由dubbox提供**的

   ```java
   @Service //import com.alibaba.dubbo.config.annotation.Service;
   public class UserServiceImpl implements UserService {
       public String getName() {		
           return "itcast";
       }
   }
   ```



##### 2 服务消费者开发

1. 在pom.xml添加Dubbox依赖（需要安装dubbox到本地Maven仓库），打包方式为**war包**。独立的工程，完成后后运行。

2. 在web.xml中添加`DispatcherServlet`加载`springmvc`配置文件、编码过滤器，IoC容器的配置文件如下：

   ```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <beans xmlns="http://www.springframework.org/schema/beans"
          xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
          xmlns:p="http://www.springframework.org/schema/p"
          xmlns:context="http://www.springframework.org/schema/context"
          xmlns:dubbo="http://code.alibabatech.com/schema/dubbo" 
          xmlns:mvc="http://www.springframework.org/schema/mvc"
          xsi:schemaLocation="http://www.springframework.org/schema/beans 
                              http://www.springframework.org/schema/beans/spring-beans.xsd
                              http://www.springframework.org/schema/mvc 
                              http://www.springframework.org/schema/mvc/spring-mvc.xsd
                              http://code.alibabatech.com/schema/dubbo 
                              http://code.alibabatech.com/schema/dubbo/dubbo.xsd
                              http://www.springframework.org/schema/context 
                              http://www.springframework.org/schema/context/spring-context.xsd">
   
       <mvc:annotation-driven >
           <mvc:message-converters register-defaults="false">
               <bean class="org.springframework.http.converter.StringHttpMessageConverter">  
                   <constructor-arg value="UTF-8" />
               </bean>  
           </mvc:message-converters>	
       </mvc:annotation-driven>
       
       <!-- 引用dubbo 服务 -->
       <dubbo:application name="dubboxdemo-web" />
       <dubbo:registry address="zookeeper://192.168.25.129:2181"/>
       <dubbo:annotation package="cn.itcast.dubboxdemo.controller" />
   </beans>
   
   ```

3. Web层：

   1. **拷贝**服务层中的**service包即其接口**
   2. 自动装配的**`@Reference`（由dubbox提供）**替代`@Autowired`

   ```java
   @Controller
   @RequestMapping("/user")
   public class UserController {
   	@Reference
   	private UserService userService;	
       
   	@RequestMapping("/showName")
   	@ResponseBody
   	public String showName(){
   		return userService.getName();
   	}		
   }
   ```


##### 3 管理中心的部署

> 开发时，需要知道注册中心都注册了哪些服务，以便我们开发和测试。管理中心就是一个web应用，部署到tomcat即可

1. 编译源码`dubbox-master.zip`中的`dubbo-admin`，得到war包：`mvn package -Dmaven.skip.test=true`跳过测试

   若要监控则编译`dubbo-monitor`

2. 将`dubbo-admin.war`移到Tomcat的webapps目录下（`mv`），启动Tomcat即可自动解压（访问用户名和密码均为root）

   如果你部署在和zookeeper同一台主机并且端口是默认的2181，则无需配置；否则需要修改WEB-INF下的dubbo.properties

   ```properties
   dubbo.registry.address=zookeeper://127.0.0.1:2181
   ```





### 1.3 品优购框架搭建

#### 1.3.1 工程结构设计分析

![](images/工程框架.png)

#### 1.3.2 数据库

看文档

#### 1.3.3 搭建框架

> 利用Maven建立maven工程、maven模块

父工程中pom.xml中只锁定版本，不依赖。其他的看文档

#### 1.3.4 实体类和数据访问层

逆向工程generatorSqlmapCustom实现实体类与数据访问层代码的自动生成，拷贝至目标，实现Serializable。具体看文档

注意：需要build path MySQL8.0的驱动包，修改正确的Driver、URL。

注意：在后续**开启服务后找不到提供者**，有可能是逆向工程生成文件的问题（多生成了几次，append），删除后重新生成并复制

#### 1.3.5 品牌列表

interface中service接口的编写……最终返回JSON数据的品牌列表





## 2 品牌管理 AngularJS

### 2.1 AngularJS

#### 2.1.1 AngularJS四大特征

> 学习的版本为Angular 1.0 即AngularJS，后续的版本去掉了JS后缀，最新为4.0……

- **MVC 模式**

  ![](images/AngularJS%E7%9A%84MVC%E6%A8%A1%E5%BC%8F.png)

- **双向绑定**

  ![1546246234248](images/%E5%8F%8C%E5%90%91%E7%BB%91%E5%AE%9A.png)

- **依赖注入**

  看最上面的图

- **模块化设计**

  高内聚低耦合法则：

  - 官方提供的模块：ng、ngRoute（路由，课程没用到）、ngAnimate（动画，课程没用到）
  - 用户自定义的模块：angular.module('模块名',[ ])



#### 2.1.2 AngularJS指令

> 引入`<script src="angular.min.js"></script>`

- `{{表达式 }}`：表达式可以是变量或是运算式

- **`ng-app`**：定义了 AngularJS 应用程序的根元素，告诉子元素以下的指令是归AngularJS 的， 会自动识别，在网页加载完毕时会自动引导（**自动初始化**）应用程序。**一般放在`body`标签中**

  ```html
  <body ng-app>
      {{100+100}}
  </body>
  ```

- **`ng-model`：双向绑定**，如下变量都是myname，都会同时改变

  ```html
  <body ng-app>
      请输入你的姓名：<input ng-model="myname"><br>
      <input ng-model="myname"><br>
      {{myname}},你好
  </body>
  ```

- **`ng-init`：初始化指令**，也可以绑定方法

  ```html
  <body ng-app   ng-init="myname='tom'">
      请输入你的姓名：<input ng-model="myname"><br>
      {{myname}},你好
  </body>
  ```



#### 2.1.3 AngularJS控制器

- **`ng-controller`：指定所使用的控制器**

- **`$scope`**服务与数据模型相关联，也是表达式执行的上下文。是**存在控制器中**用于**视图和控制器之间交换数据**

  ```html
  <html>
      <head>
          <title>控制器</title>
          <script src="angular.min.js"></script>
          <script>
              //定义了一个叫myApp的模块，第二个参数数组为引用的模块，没有则不写
              var app=angular.module('myApp',[]); 
              //定义控制器
              app.controller('myController',function($scope){
                  $scope.add=function(){
                      return parseInt($scope.x)+parseInt($scope.y);
                  }
              });
          </script>
      </head>
      <body ng-app="myApp" ng-controller="myController">
          x:<input ng-model="x" >
          y:<input ng-model="y" >
          运算结果：{{add()}}
      </body>
  </html>
  ```

#### 2.1.4 AngularJS事件

- **`ng-click`**

  ```html
  <html>
      <head>
          <title>入门小Demo-5  事件指令</title>
          <script src="angular.min.js"></script>	
          <script>
              //定义了一个叫myApp的模块，第二个参数数组为引用的模块，没有则不写
              var app=angular.module('myApp',[]);
              //定义控制器
              app.controller('myController',function($scope){			
                  $scope.add=function(){
                      $scope.z= parseInt($scope.x)+parseInt($scope.y);
                  }			
              });	
          </script>
      </head>
      <body ng-app="myApp" ng-controller="myController">
          x:<input ng-model="x" >
          y:<input ng-model="y" >
          <button ng-click="add()">运算</button>
          结果：{{z}}
      </body>
  </html>
  ```

#### 2.1.5 AngularJS遍历

- **`ng-repeat`**

  ```html
  <html>
      <head>
          <title>循环数据</title>
          <script src="angular.min.js"></script>
          <script>
              //定义了一个叫myApp的模块，第二个参数数组为引用的模块，没有则不写
              var app=angular.module('myApp',[]);
              //定义控制器
              app.controller('myController',function($scope){
                  $scope.list1= [100,192,203,434 ];//定义数组
                  $scope.list2= [
                      {name:'张三',shuxue:100,yuwen:93},
                      {name:'李四',shuxue:88,yuwen:87},
                      {name:'王五',shuxue:77,yuwen:56}
                  ];//定义数组
              });
          </script>
      </head>
      <body ng-app="myApp" ng-controller="myController">
          <table>
              <tr ng-repeat="x in list">
                  <td>{{x}}</td>
              </tr>
          </table>
  	<!--===============================================================-->
          <table>
              <tr>
                  <td>姓名</td>
                  <td>数学</td>
                  <td>语文</td>
              </tr>
              <tr ng-repeat="entity in list">
                  <td>{{entity.name}}</td>
                  <td>{{entity.shuxue}}</td>
                  <td>{{entity.yuwen}}</td>
              </tr>
          </table>
      </body>
  </html>
  ```



#### 2.1.6 内置服务$http

- 我们的数据一般都是从后端获取的，可以使用内置服务`$http`来实现。以下代码要在Web环境中运行（运行在Tomcat中）

  ```html
  <html>
      <head>
          <title>内置服务</title>
          <meta charset="utf-8" />
          <script src="angular.min.js"></script>
          <script>
              var app=angular.module('myApp',[]);
              app.controller('myController',function($scope,$http){
                  $scope.findAll=function(){
                      $http.get('data.json').success(
                          function(data){
                              $scope.list=data;
                          }
                      );
                  }
              });
          </script>
      </head>
      <body ng-app="myApp" ng-controller="myController" ng-init="findAll()">
          <table>
              <tr>
                  <td>姓名</td>
                  <td>数学</td>
                  <td>语文</td>
              </tr>
              <tr ng-repeat="entity in list">
                  <td>{{entity.name}}</td>
                  <td>{{entity.shuxue}}</td>
                  <td>{{entity.yuwen}}</td>
              </tr>
          </table>
      </body>
  </html>
  ```



### 2.2 品牌列表分页实现

后端：利用Pagehelper及PageInfo即可完成。其实只需返回**总记录数`total`**、**分页后的数据`list`**即可

前端：

- 引入Angular的分页组件

  ```html
  <script src="../plugins/angularjs/pagination.js"></script>
  <link rel="stylesheet" href="../plugins/angularjs/pagination.css">
  ```

- 在表格后放入分页组件

  ```html
  <!--在body中引入如下模块和控制器-->
  <body ng-app="pinyougou" ng-controller="brandController">
      <tm-pagination conf="paginationConf"></tm-pagination> <!--分页组件-->
  </body>
  ```

- AngularJS控制器代码

  ```javascript
  //构建品优购app模块时引入pagination模块
  var app = angular.module("pinyougou", ['pagination']);
  app.controller("brandController", function ($scope, $http) { //引入$scope, $http服务
  
      //分页组件配置
      $scope.paginationConf = {
          currentPage: 1, //当前页码
          totalItems: 10, //总记录数
          itemsPerPage: 10, //每页显示记录数，有如下选项
          perPageOptions: [10, 20, 30, 40, 50],
          onChange: function () { //每次更改（更新）页面时触发事件
              $scope.reloadList();
          }
      };
  
      //重新加载封装，只为了简写
      $scope.reloadList = function () {
          $scope.findAll($scope.paginationConf.currentPage, $scope.paginationConf.itemsPerPage);
      };
  
      //调用后端查找分页数据
      $scope.findAll = function (pageNum, pageSize) {
          $http.get("../brand/findAll.do?pageNum=" + pageNum + "&pageSize=" + pageSize).success(
              function (data) {
                  $scope.list = data.list;//返回查找的数据
                  $scope.paginationConf.totalItems = data.total;//更新总记录数totalItems
              }
          );
      };
  });
  ```





